<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard | HealthCare Hospital</title>
    <link rel="stylesheet" href="../styles.css" />
    <link rel="stylesheet" href="dashboard.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <style>
      /* All dashboard styles moved to dashboard.css */
    </style>
  </head>
  <body>
    <div class="dashboard-container">
      <aside class="sidebar">
        <div class="sidebar-header">
          <img src="../IMAGES/logo-removebg-preview.png" alt="Logo" />
          Admin Panel
        </div>
        <nav class="sidebar-menu">
          <ul>
            <li>
              <a href="#" class="active"
                ><i class="fa fa-tachometer-alt"></i> Dashboard</a
              >
            </li>
            <li>
              <a href="#"><i class="fa fa-user-md"></i> Doctors</a>
            </li>
            <li>
              <a href="#"><i class="fa fa-calendar-check"></i> Appointments</a>
            </li>
            <li>
              <a href="#"><i class="fa fa-briefcase-medical"></i> Services</a>
            </li>
            <li>
              <a href="#"><i class="fa fa-envelope"></i> Messages</a>
            </li>
            <li>
              <a href="#"><i class="fa fa-cogs"></i> Settings</a>
            </li>
          </ul>
        </nav>
        <div class="sidebar-footer">
          <i class="fa fa-user-shield"></i> Admin |
          <span id="current-date"></span>
        </div>
      </aside>
      <main class="main-content">
        <div class="dashboard-header">
          <h1>Welcome, Admin</h1>
          <div class="admin-info">
            <i class="fa fa-user-circle"></i> admin@lekeakaakematu.com
          </div>
        </div>
        <!-- Dashboard Section -->
        <section id="dashboard-section" class="dashboard-section-content">
          <div class="dashboard-stats">
            <div class="stat-card">
              <span class="stat-icon"><i class="fa fa-user-md"></i></span>
              <span class="stat-label">Doctors</span>
              <span class="stat-value">18</span>
            </div>
            <div class="stat-card">
              <span class="stat-icon"><i class="fa fa-users"></i></span>
              <span class="stat-label">Patients</span>
              <span class="stat-value">245</span>
            </div>
            <div class="stat-card">
              <span class="stat-icon"
                ><i class="fa fa-calendar-check"></i
              ></span>
              <span class="stat-label">Appointments</span>
              <span class="stat-value">32</span>
            </div>
            <div class="stat-card">
              <span class="stat-icon"
                ><i class="fa fa-briefcase-medical"></i
              ></span>
              <span class="stat-label">Services</span>
              <span class="stat-value">12</span>
            </div>
          </div>
          <div class="dashboard-section">
            <h2>Recent Appointments</h2>
            <table class="recent-table">
              <thead>
                <tr>
                  <th>Patient</th>
                  <th>Doctor</th>
                  <th>Date</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="recent-appointments-tbody">
                <!-- Dynamic rows will be rendered by JS -->
              </tbody>
            </table>
          </div>
          <div class="dashboard-section">
            <h2>Recent Messages</h2>
            <table class="recent-table">
              <thead>
                <tr>
                  <th>From</th>
                  <th>Email</th>
                  <th>Subject</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody id="recent-messages-tbody">
                <!-- Dynamic rows will be rendered by JS -->
              </tbody>
            </table>
          </div>
        </section>
        <!-- Doctors Section -->
        <section
          id="doctors-section"
          class="dashboard-section-content"
          style="display: none"
        >
          <h2>Doctors Management</h2>
          <button class="add-btn" id="add-doctor-btn">
            <i class="fa fa-plus"></i> Add Doctor
          </button>
          <table class="recent-table" id="doctors-table">
            <thead>
              <tr>
                <th>Image</th>
                <th>Name</th>
                <th>Specialty</th>
                <th>Email</th>
                <th>Phone</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="doctors-tbody"></tbody>
          </table>
          <!-- Doctor Modal -->
          <div id="doctor-modal" class="modal" style="display: none">
            <div class="modal-content">
              <span class="close-modal" id="close-doctor-modal">&times;</span>
              <h3 id="doctor-modal-title">Add Doctor</h3>
              <form id="doctor-form" enctype="multipart/form-data">
                <div class="form-group">
                  <label for="doctor-name">Name</label>
                  <input type="text" id="doctor-name" name="name" required />
                </div>
                <div class="form-group">
                  <label for="doctor-specialty">Specialty</label>
                  <input
                    type="text"
                    id="doctor-specialty"
                    name="specialty"
                    required
                  />
                </div>
                <div class="form-group">
                  <label for="doctor-email">Email</label>
                  <input type="email" id="doctor-email" name="email" required />
                </div>
                <div class="form-group">
                  <label for="doctor-phone">Phone</label>
                  <input type="text" id="doctor-phone" name="phone" required />
                </div>
                <div class="form-group">
                  <label for="doctor-bio">About</label>
                  <textarea
                    id="doctor-bio"
                    name="bio"
                    rows="3"
                    placeholder="Write about the doctor..."
                  ></textarea>
                </div>
                <div class="form-group">
                  <label for="doctor-image">Image</label>
                  <input
                    type="file"
                    id="doctor-image"
                    name="image"
                    accept="image/*"
                  />
                  <img
                    id="doctor-image-preview"
                    src=""
                    alt="Preview"
                    style="display: none; max-width: 120px; margin-top: 0.5rem"
                  />
                </div>
                <input type="hidden" id="doctor-id" name="id" />
                <button type="submit" class="save-btn">Save</button>
                <div
                  id="doctor-form-error"
                  style="color: #d32f2f; display: none; margin-top: 0.7rem"
                ></div>
                <div
                  id="doctor-form-success"
                  style="color: #388e3c; display: none; margin-top: 0.7rem"
                >
                  Doctor saved successfully!
                </div>
              </form>
            </div>
          </div>
        </section>
        <!-- Appointments Section -->
        <section
          id="appointments-section"
          class="dashboard-section-content"
          style="display: none"
        >
          <h2>Appointments Management</h2>
          <div
            style="
              display: flex;
              gap: 1rem;
              align-items: center;
              margin-bottom: 1rem;
              flex-wrap: wrap;
            "
          >
            <label
              >Doctor:
              <select id="filter-appointment-doctor">
                <option value="">All</option>
                <option value="Dr. Smith">Dr. Smith</option>
                <option value="Dr. Adams">Dr. Adams</option>
                <option value="Dr. Brown">Dr. Brown</option>
                <option value="Dr. Patel">Dr. Patel</option>
              </select>
            </label>
            <label
              >Status:
              <select id="filter-appointment-status">
                <option value="">All</option>
                <option value="Completed">Completed</option>
                <option value="Pending">Pending</option>
                <option value="Cancelled">Cancelled</option>
              </select>
            </label>
            <button class="add-btn" id="add-appointment-btn">
              <i class="fa fa-plus"></i> Add Appointment
            </button>
          </div>
          <table class="recent-table" id="appointments-table">
            <thead>
              <tr>
                <th>Patient</th>
                <th>Doctor</th>
                <th>Date</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="appointments-tbody">
              <!-- Dynamic rows will be rendered by JS -->
            </tbody>
          </table>
          <!-- Prescription Modal -->
          <div id="prescription-modal" class="modal" style="display: none">
            <div class="modal-content" style="max-width: 420px">
              <span class="close-modal" id="close-prescription-modal"
                >&times;</span
              >
              <h3>Create/View Prescription</h3>
              <form id="prescription-form">
                <div class="form-group">
                  <label for="prescription-notes">Prescription Notes</label>
                  <textarea
                    id="prescription-notes"
                    rows="3"
                    style="
                      width: 100%;
                      border-radius: 0.7rem;
                      border: 1px solid #b3c6e0;
                      padding: 0.5rem;
                    "
                  ></textarea>
                </div>
                <div class="form-group">
                  <label for="prescription-file">Attach File (PDF/Image)</label>
                  <input
                    type="file"
                    id="prescription-file"
                    accept=".pdf,image/*"
                  />
                </div>
                <button type="submit" class="save-btn" style="margin-top: 1rem">
                  <i class="fa fa-save"></i> Save Prescription
                </button>
              </form>
              <div style="margin-top: 1.5rem">
                <h4>Previous Prescriptions</h4>
                <ul
                  id="previous-prescriptions"
                  style="list-style: none; padding: 0"
                >
                  <li>No previous prescriptions.</li>
                </ul>
              </div>
            </div>
          </div>
        </section>
        <!-- Services Section -->
        <section
          id="services-section"
          class="dashboard-section-content"
          style="display: none"
        >
          <h2>Services Management</h2>
          <button class="add-btn" id="add-service-btn">
            <i class="fa fa-plus"></i> Add Service
          </button>
          <table class="recent-table" id="services-table">
            <thead>
              <tr>
                <th>Service Name</th>
                <th>Department</th>
                <th>Description</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="services-tbody">
              <tr>
                <td>Cardiology</td>
                <td>Heart</td>
                <td>Heart-related treatments</td>
                <td>
                  <button class="edit-btn"><i class="fa fa-edit"></i></button>
                  <button class="delete-btn">
                    <i class="fa fa-trash"></i>
                  </button>
                </td>
              </tr>
              <tr>
                <td>Radiology</td>
                <td>Imaging</td>
                <td>X-ray, MRI, CT scan</td>
                <td>
                  <button class="edit-btn"><i class="fa fa-edit"></i></button>
                  <button class="delete-btn">
                    <i class="fa fa-trash"></i>
                  </button>
                </td>
              </tr>
            </tbody>
          </table>
          <!-- Service Modal -->
          <div id="service-modal" class="modal" style="display: none">
            <div class="modal-content">
              <span class="close-modal" id="close-service-modal">&times;</span>
              <h3 id="service-modal-title">Add Service</h3>
              <form id="service-form">
                <input type="hidden" id="service-index" />
                <label
                  >Service Name:<input type="text" id="service-name" required
                /></label>
                <label
                  >Department:<input
                    type="text"
                    id="service-department"
                    required
                /></label>
                <label
                  >Description:<input
                    type="text"
                    id="service-description"
                    required
                /></label>
                <button type="submit" class="save-btn">
                  <i class="fa fa-save"></i> Save
                </button>
              </form>
            </div>
          </div>
        </section>
        <!-- Messages Section -->
        <section
          id="messages-section"
          class="dashboard-section-content"
          style="display: none"
        >
          <h2>Messages</h2>
          <table class="recent-table" id="messages-table">
            <thead>
              <tr>
                <th>From</th>
                <th>Email</th>
                <th>Subject</th>
                <th>Date</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="messages-tbody">
              <!-- Dynamic rows -->
            </tbody>
          </table>
          <!-- Message View Modal -->
          <div id="message-view-modal" class="modal" style="display: none">
            <div class="modal-content" style="max-width: 420px; padding: 2rem 2.5rem; border-radius: 1.2rem; background: #fff; box-shadow: 0 8px 32px rgba(0,0,0,0.18); position: relative;">
              <span class="close-modal" id="close-message-view-modal" style="position: absolute; top: 18px; right: 22px; font-size: 2rem; color: #888; cursor: pointer; transition: color 0.2s; z-index: 2;">&times;</span>
              <h3 style="margin-bottom: 1.2rem; color: #2a3b4c; font-size: 1.3rem; font-weight: 600; text-align: center;">Message Details</h3>
              <div id="message-view-content" style="font-size: 1.08rem; color: #222; line-height: 1.7; background: #f7fafd; border-radius: 0.7rem; padding: 1.2rem 1.1rem; border: 1px solid #e3e9f2;"></div>
              <button id="close-message-view-btn" style="margin: 1.5rem auto 0 auto; display: block; background: #2a7be4; color: #fff; border: none; border-radius: 0.5rem; padding: 0.6rem 1.6rem; font-size: 1rem; cursor: pointer; transition: background 0.2s;">Close</button>
            </div>
          </div>
        </section>
        <!-- Settings Section -->
        <section
          id="settings-section"
          class="dashboard-section-content"
          style="display: none"
        >
          <h2>Settings</h2>
          <form class="settings-form">
            <label
              >Admin Email:
              <input type="email" value="admin@lekeakaakematu.com" />
            </label>
            <label
              >Change Password:
              <input type="password" placeholder="New Password" />
            </label>
            <button type="submit" class="save-btn">
              <i class="fa fa-save"></i> Save Changes
            </button>
          </form>
        </section>
      </main>
    </div>
    <script>
      // Set current date in sidebar
      document.getElementById("current-date").textContent =
        new Date().toLocaleDateString();
      // Section switching logic
      const sectionMap = {
        "dashboard-section": "dashboard-section",
        "doctors-section": "doctors-section",
        "appointments-section": "appointments-section",
        "services-section": "services-section",
        "messages-section": "messages-section",
        "settings-section": "settings-section",
      };
      const navLinks = document.querySelectorAll(".sidebar-menu a");
      function showSection(sectionId) {
        Object.values(sectionMap).forEach((id) => {
          const sec = document.getElementById(id);
          if (sec) sec.style.display = "none";
        });
        const activeSection = document.getElementById(sectionId);
        if (activeSection) activeSection.style.display = "";
        if (sectionId === "doctors-section") renderDoctors();
        if (sectionId === "appointments-section") renderAppointments();
        if (sectionId === "services-section") renderServices();
        if (sectionId === "messages-section") renderMessages();
      }
      navLinks.forEach((link) => {
        link.addEventListener("click", function (e) {
          e.preventDefault();
          navLinks.forEach((l) => l.classList.remove("active"));
          this.classList.add("active");
          let text = this.textContent.trim().toLowerCase();
          let sectionId = "dashboard-section";
          if (text.includes("doctor")) sectionId = "doctors-section";
          else if (text.includes("appointment"))
            sectionId = "appointments-section";
          else if (text.includes("service")) sectionId = "services-section";
          else if (text.includes("message")) sectionId = "messages-section";
          else if (text.includes("setting")) sectionId = "settings-section";
          showSection(sectionId);
        });
      });
      // Show dashboard by default
      showSection("dashboard-section");
      // Doctors CRUD logic
      const doctorsTbody = document.getElementById("doctors-tbody");
      const addDoctorBtn = document.getElementById("add-doctor-btn");
      const doctorModal = document.getElementById("doctor-modal");
      const closeDoctorModal = document.getElementById("close-doctor-modal");
      const doctorForm = document.getElementById("doctor-form");
      const doctorModalTitle = document.getElementById("doctor-modal-title");
      const doctorIndexInput = document.getElementById("doctor-index");
      const doctorNameInput = document.getElementById("doctor-name");
      const doctorSpecialtyInput = document.getElementById("doctor-specialty");
      const doctorEmailInput = document.getElementById("doctor-email");
      const doctorPhoneInput = document.getElementById("doctor-phone");
      const doctorBioInput = document.getElementById("doctor-bio");
      const doctorImageInput = document.getElementById("doctor-image");
      const doctorImagePreview = document.getElementById(
        "doctor-image-preview"
      );
      function doctorRowHTML(doc, idx) {
        let imageUrl = "../IMAGES/logo-removebg-preview.png";
        if (
          doc.image &&
          typeof doc.image === "string" &&
          doc.image.trim() !== ""
        ) {
          imageUrl = doc.image;
        }
        return `<tr>
<td style="position:relative;width:60px;height:48px;">
  <img src="../IMAGES/logo-removebg-preview.png" alt="Logo" style="width:48px;height:48px;object-fit:cover;border-radius:50%;border:1px solid #ccc;position:absolute;left:0;top:0;z-index:1;opacity:0.5;" />
  <img src="${imageUrl}" alt="Doctor Image" style="width:48px;height:48px;object-fit:cover;border-radius:50%;border:1px solid #ccc;position:absolute;left:0;top:0;z-index:2;" onerror="this.style.display='none';" />
</td>
<td>${doc.name}</td>
<td>${doc.specialty}</td>
<td>${doc.email || ""}</td>
<td>${doc.phone || ""}</td>
<td>
  <button class="edit-btn" data-id="${doc._id}"><i class="fa fa-edit"></i></button>
  <button class="delete-btn" data-id="${doc._id}"><i class="fa fa-trash"></i></button>
</td>
</tr>`;
      }
      async function renderDoctors() {
        const doctors = await fetchDoctors();
        const tbody = document.getElementById("doctors-tbody");
        tbody.innerHTML = doctors.map(doctorRowHTML).join("");
      }
      renderDoctors();
      function openDoctorModal(editIdx = null) {
        doctorModal.style.display = "block";
        if (editIdx !== null) {
          doctorModalTitle.textContent = "Edit Doctor";
          doctorIndexInput.value = editIdx;
          doctorNameInput.value = doctorsData[editIdx].name;
          doctorSpecialtyInput.value = doctorsData[editIdx].specialty;
          doctorEmailInput.value = doctorsData[editIdx].email;
          doctorPhoneInput.value = doctorsData[editIdx].phone;
          doctorBioInput.value = doctorsData[editIdx].bio || "";
          doctorImagePreview.src = doctorsData[editIdx].image || "";
          doctorImagePreview.style.display = doctorImagePreview.src
            ? "block"
            : "none";
        } else {
          doctorModalTitle.textContent = "Add Doctor";
          doctorIndexInput.value = "";
          doctorForm.reset();
          doctorImagePreview.src = "";
          doctorImagePreview.style.display = "none";
        }
      }
      function closeDoctorModalFunc() {
        doctorModal.style.display = "none";
        doctorForm.reset();
      }
      addDoctorBtn.addEventListener("click", () => openDoctorModal());
      closeDoctorModal.addEventListener("click", closeDoctorModalFunc);
      doctorForm.addEventListener("submit", async function (e) {
        e.preventDefault();
        const form = document.getElementById("doctor-form");
        const formData = new FormData(form);
        const errorDiv = document.getElementById("doctor-form-error");
        const successDiv = document.getElementById("doctor-form-success");
        errorDiv.style.display = "none";
        successDiv.style.display = "none";
        try {
          const res = await fetch("http://localhost:5000/api/doctors", {
            method: "POST",
            body: formData,
          });
          if (res.ok) {
            successDiv.style.display = "block";
            setTimeout(() => {
              document.getElementById("doctor-modal").style.display = "none";
              successDiv.style.display = "none";
              renderDoctors();
              updateDashboardStats();
            }, 1200);
          } else {
            const data = await res.json().catch(() => ({}));
            errorDiv.textContent = data.message || "Failed to add doctor.";
            errorDiv.style.display = "block";
          }
        } catch {
          errorDiv.textContent = "Server error.";
          errorDiv.style.display = "block";
        }
      });
      doctorsTbody.addEventListener("click", function (e) {
        if (e.target.closest(".edit-btn")) {
          const id = e.target.closest(".edit-btn").dataset.id;
          // Fetch doctor by id and open modal for editing (implement as needed)
          // openDoctorModal(id); // You may need to fetch the doctor data by id
          alert('Edit doctor feature coming soon!');
        } else if (e.target.closest(".delete-btn")) {
          const id = e.target.closest(".delete-btn").dataset.id;
          if (confirm("Are you sure you want to delete this doctor?")) {
            deleteDoctor(id).then((success) => {
              if (success) {
                renderDoctors();
              } else {
                alert("Failed to delete doctor.");
              }
            });
          }
        }
      });
      // Modal close on outside click
      window.addEventListener("mousedown", function (e) {
        if (
          doctorModal.style.display === "block" &&
          !doctorModal.querySelector(".modal-content").contains(e.target) &&
          e.target !== addDoctorBtn
        ) {
          closeDoctorModalFunc();
        }
      });
      // Appointments CRUD logic
      const appointmentsTbody = document.querySelector(
        "#appointments-section tbody"
      );
      const addAppointmentBtn = document.querySelector(
        "#appointments-section .add-btn"
      );
      let appointmentModal = null,
        closeAppointmentModal = null,
        appointmentForm = null,
        appointmentModalTitle = null,
        appointmentIndexInput = null;
      let appointmentPatientInput = null,
        appointmentDoctorInput = null,
        appointmentDateInput = null,
        appointmentStatusInput = null;

      // Load appointments from localStorage (user bookings)
      function getLocalAppointments() {
        try {
          return JSON.parse(localStorage.getItem("appointmentsData")) || [];
        } catch {
          return [];
        }
      }

      // Modal HTML for Appointments
      function ensureAppointmentModal() {
        if (document.getElementById("appointment-modal")) return;
        const modal = document.createElement("div");
        modal.id = "appointment-modal";
        modal.className = "modal";
        modal.style.display = "none";
        modal.innerHTML = `
              <div class="modal-content">
                <span class="close-modal" id="close-appointment-modal">&times;</span>
                <h3 id="appointment-modal-title">Add Appointment</h3>
                <form id="appointment-form">
                  <input type="hidden" id="appointment-index" />
                  <label>Patient:<input type="text" id="appointment-patient" required /></label>
                  <label>Doctor:<input type="text" id="appointment-doctor" required /></label>
                  <label>Date:<input type="date" id="appointment-date" required /></label>
                  <label>Status:
                    <select id="appointment-status" required>
                      <option value="Completed">Completed</option>
                      <option value="Pending">Pending</option>
                      <option value="Cancelled">Cancelled</option>
                    </select>
                  </label>
                  <button type="submit" class="save-btn"><i class="fa fa-save"></i> Save</button>
                </form>
              </div>
            `;
        document.querySelector("#appointments-section").appendChild(modal);
      }

      // --- Fetch and Render Appointments from Backend ---
      async function fetchAppointmentsFromBackend() {
        try {
          const res = await fetch("http://localhost:5000/api/appointments");
          if (!res.ok) throw new Error("Failed");
          const data = await res.json();
          return data;
        } catch {
          return [];
        }
      }
      async function deleteAppointment(id) {
        try {
          const res = await fetch(`http://localhost:5000/api/appointments/${id}`, { method: "DELETE" });
          return res.ok;
        } catch {
          return false;
        }
      }
      async function updateAppointmentStatus(id, status) {
        try {
          const res = await fetch(`http://localhost:5000/api/appointments/${id}/status`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status })
          });
          return res.ok;
        } catch {
          return false;
        }
      }
      async function renderAppointments() {
        const allApps = await fetchAppointmentsFromBackend();
        appointmentsTbody.innerHTML = "";
        allApps.forEach((app, idx) => {
          const tr = document.createElement("tr");
          const statusVal = app.status || "Pending";
          tr.innerHTML = `
      <td>${app.patientName || app.patient}</td>
      <td>${app.doctorName || app.doctor}</td>
      <td>${app.date} ${app.time ? app.time : ""}</td>
      <td>
        <select class="status-select" data-id="${app._id}">
          <option value="Pending" ${statusVal === "Pending" ? "selected" : ""}>Pending</option>
          <option value="Completed" ${statusVal === "Completed" ? "selected" : ""}>Completed</option>
          <option value="Cancelled" ${statusVal === "Cancelled" ? "selected" : ""}>Cancelled</option>
        </select>
      </td>
      <td>
        <button class="edit-btn" data-idx="${idx}"><i class="fa fa-edit"></i></button>
        <button class="delete-btn" data-id="${app._id}"><i class="fa fa-trash"></i></button>
      </td>
    `;
          appointmentsTbody.appendChild(tr);
        });
      }
      // On page load, fetch and render appointments
      renderAppointments();
      function openAppointmentModal(editIdx = null) {
        ensureAppointmentModal();
        appointmentModal = document.getElementById("appointment-modal");
        closeAppointmentModal = document.getElementById(
          "close-appointment-modal"
        );
        appointmentForm = document.getElementById("appointment-form");
        appointmentModalTitle = document.getElementById(
          "appointment-modal-title"
        );
        appointmentIndexInput = document.getElementById("appointment-index");
        appointmentPatientInput = document.getElementById(
          "appointment-patient"
        );
        appointmentDoctorInput = document.getElementById("appointment-doctor");
        appointmentDateInput = document.getElementById("appointment-date");
        appointmentStatusInput = document.getElementById("appointment-status");
        appointmentModal.style.display = "block";
        if (editIdx !== null) {
          appointmentModalTitle.textContent = "Edit Appointment";
          appointmentIndexInput.value = editIdx;
          appointmentPatientInput.value = appointmentsData[editIdx].patient;
          appointmentDoctorInput.value = appointmentsData[editIdx].doctor;
          appointmentDateInput.value = appointmentsData[editIdx].date;
          appointmentStatusInput.value = appointmentsData[editIdx].status;
        } else {
          appointmentModalTitle.textContent = "Add Appointment";
          appointmentIndexInput.value = "";
          appointmentForm.reset();
        }
      }
      function closeAppointmentModalFunc() {
        appointmentModal.style.display = "none";
        appointmentForm.reset();
      }
      if (addAppointmentBtn)
        addAppointmentBtn.addEventListener("click", () =>
          openAppointmentModal()
        );
      document.addEventListener("click", function (e) {
        if (e.target && e.target.id === "close-appointment-modal")
          closeAppointmentModalFunc();
      });
      document.addEventListener("submit", function (e) {
        if (e.target && e.target.id === "appointment-form") {
          e.preventDefault();
          const idx = appointmentIndexInput.value;
          const newApp = {
            patient: appointmentPatientInput.value,
            doctor: appointmentDoctorInput.value,
            date: appointmentDateInput.value,
            status: appointmentStatusInput.value,
          };
          if (idx === "") appointmentsData.push(newApp);
          else appointmentsData[idx] = newApp;
          renderAppointments();
          closeAppointmentModalFunc();
        }
      });
      appointmentsTbody.addEventListener("click", function (e) {
        if (e.target.closest(".edit-btn")) {
          const idx = e.target.closest(".edit-btn").dataset.idx;
          openAppointmentModal(idx);
        } else if (e.target.closest(".delete-btn")) {
          const id = e.target.closest(".delete-btn").dataset.id;
          if (confirm("Are you sure you want to delete this appointment?")) {
            deleteAppointment(id).then((success) => {
              if (success) {
                renderAppointments();
              } else {
                alert("Failed to delete appointment.");
              }
            });
          }
        }
      });
      appointmentsTbody.addEventListener("change", async function (e) {
        if (e.target.classList.contains("status-select")) {
          const id = e.target.dataset.id;
          const status = e.target.value;
          if (await updateAppointmentStatus(id, status)) {
            // Optionally show a success message
          } else {
            alert("Failed to update status.");
          }
        }
      });
      window.addEventListener("mousedown", function (e) {
        ensureAppointmentModal();
        if (
          appointmentModal &&
          appointmentModal.style.display === "block" &&
          !appointmentModal
            .querySelector(".modal-content")
            .contains(e.target) &&
          e.target !== addAppointmentBtn
        ) {
          closeAppointmentModalFunc();
        }
      });
      // Services CRUD logic
      const servicesTbody = document.querySelector("#services-section tbody");
      const addServiceBtn = document.querySelector(
        "#services-section .add-btn"
      );
      let serviceModal = null,
        closeServiceModal = null,
        serviceForm = null,
        serviceModalTitle = null,
        serviceIndexInput = null;
      let serviceNameInput = null,
        serviceDeptInput = null,
        serviceDescInput = null;
      function ensureServiceModal() {
        if (document.getElementById("service-modal")) return;
        const modal = document.createElement("div");
        modal.id = "service-modal";
        modal.className = "modal";
        modal.style.display = "none";
        modal.innerHTML = `
              <div class="modal-content">
                <span class="close-modal" id="close-service-modal">&times;</span>
                <h3 id="service-modal-title">Add Service</h3>
                <form id="service-form">
                  <input type="hidden" id="service-index" />
                  <label>Service Name:<input type="text" id="service-name" required /></label>
                  <label>Department:<input type="text" id="service-dept" required /></label>
                  <label>Description:<input type="text" id="service-desc" required /></label>
                  <button type="submit" class="save-btn"><i class="fa fa-save"></i> Save</button>
                </form>
              </div>
            `;
        document.querySelector("#services-section").appendChild(modal);
      }
      let servicesData = [
        { name: "Cardiology", dept: "Heart", desc: "Heart-related treatments" },
        { name: "Radiology", dept: "Imaging", desc: "X-ray, MRI, CT scan" },
      ];
      function renderServices() {
        servicesTbody.innerHTML = "";
        servicesData.forEach((srv, idx) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
                <td>${srv.name}</td>
                <td>${srv.dept}</td>
                <td>${srv.desc}</td>
                <td>
                  <button class="edit-btn" data-idx="${idx}"><i class="fa fa-edit"></i></button>
                  <button class="delete-btn" data-idx="${idx}"><i class="fa fa-trash"></i></button>
                </td>
              `;
          servicesTbody.appendChild(tr);
        });
      }
      function openServiceModal(editIdx = null) {
        ensureServiceModal();
        serviceModal = document.getElementById("service-modal");
        closeServiceModal = document.getElementById("close-service-modal");
        serviceForm = document.getElementById("service-form");
        serviceModalTitle = document.getElementById("service-modal-title");
        serviceIndexInput = document.getElementById("service-index");
        serviceNameInput = document.getElementById("service-name");
        serviceDeptInput = document.getElementById("service-dept");
        serviceDescInput = document.getElementById("service-desc");
        serviceModal.style.display = "block";
        if (editIdx !== null) {
          serviceModalTitle.textContent = "Edit Service";
          serviceIndexInput.value = editIdx;
          serviceNameInput.value = servicesData[editIdx].name;
          serviceDeptInput.value = servicesData[editIdx].dept;
          serviceDescInput.value = servicesData[editIdx].desc;
        } else {
          serviceModalTitle.textContent = "Add Service";
          serviceIndexInput.value = "";
          serviceForm.reset();
        }
      }
      function closeServiceModalFunc() {
        serviceModal.style.display = "none";
        serviceForm.reset();
      }
      if (addServiceBtn)
        addServiceBtn.addEventListener("click", () => openServiceModal());
      document.addEventListener("click", function (e) {
        if (e.target && e.target.id === "close-service-modal")
          closeServiceModalFunc();
      });
      document.addEventListener("submit", function (e) {
        if (e.target && e.target.id === "service-form") {
          e.preventDefault();
          const idx = serviceIndexInput.value;
          const newSrv = {
            name: serviceNameInput.value,
            dept: serviceDeptInput.value,
            desc: serviceDescInput.value,
          };
          if (idx === "") servicesData.push(newSrv);
          else servicesData[idx] = newSrv;
          renderServices();
          closeServiceModalFunc();
        }
      });
      servicesTbody.addEventListener("click", function (e) {
        if (e.target.closest(".edit-btn")) {
          const idx = e.target.closest(".edit-btn").dataset.idx;
          openServiceModal(idx);
        } else if (e.target.closest(".delete-btn")) {
          const idx = e.target.closest(".delete-btn").dataset.idx;
          if (confirm("Are you sure you want to delete this service?")) {
            servicesData.splice(idx, 1);
            renderServices();
          }
        }
      });
      window.addEventListener("mousedown", function (e) {
        ensureServiceModal();
        if (
          serviceModal &&
          serviceModal.style.display === "block" &&
          !serviceModal.querySelector(".modal-content").contains(e.target) &&
          e.target !== addServiceBtn
        ) {
          closeServiceModalFunc();
        }
      });
      // Messages CRUD logic
      const messagesTbody = document.querySelector("#messages-section tbody");
      let addMessageBtn = null; // No add button in UI, but logic is here for completeness
      let messageModal = null,
        closeMessageModal = null,
        messageForm = null,
        messageModalTitle = null,
        messageIndexInput = null;
      let messageFromInput = null,
        messageEmailInput = null,
        messageSubjectInput = null,
        messageDateInput = null;
      let messageViewModal = null,
        closeMessageViewModal = null,
        messageViewContent = null;
      function ensureMessageModal() {
        if (document.getElementById("message-modal")) return;
        const modal = document.createElement("div");
        modal.id = "message-modal";
        modal.className = "modal";
        modal.style.display = "none";
        modal.innerHTML = `
              <div class="modal-content">
                <span class="close-modal" id="close-message-modal">&times;</span>
                <h3 id="message-modal-title">Add Message</h3>
                <form id="message-form">
                  <input type="hidden" id="message-index" />
                  <label>From:<input type="text" id="message-from" required /></label>
                  <label>Email:<input type="email" id="message-email" required /></label>
                  <label>Subject:<input type="text" id="message-subject" required /></label>
                  <label>Date:<input type="date" id="message-date" required /></label>
                  <button type="submit" class="save-btn"><i class="fa fa-save"></i> Save</button>
                </form>
              </div>
            `;
        document.querySelector("#messages-section").appendChild(modal);
      }
      function ensureMessageViewModal() {
        if (document.getElementById("message-view-modal")) return;
        const modal = document.createElement("div");
        modal.id = "message-view-modal";
        modal.className = "modal";
        modal.style.display = "none";
        modal.innerHTML = `
              <div class="modal-content" style="max-width: 420px; padding: 2rem 2.5rem; border-radius: 1.2rem; background: #fff; box-shadow: 0 8px 32px rgba(0,0,0,0.18); position: relative;">
                <span class="close-modal" id="close-message-view-modal" style="position: absolute; top: 18px; right: 22px; font-size: 2rem; color: #888; cursor: pointer; transition: color 0.2s; z-index: 2;">&times;</span>
                <h3 style="margin-bottom: 1.2rem; color: #2a3b4c; font-size: 1.3rem; font-weight: 600; text-align: center;">Message Details</h3>
                <div id="message-view-content" style="font-size: 1.08rem; color: #222; line-height: 1.7; background: #f7fafd; border-radius: 0.7rem; padding: 1.2rem 1.1rem; border: 1px solid #e3e9f2;"></div>
                <button id="close-message-view-btn" style="margin: 1.5rem auto 0 auto; display: block; background: #2a7be4; color: #fff; border: none; border-radius: 0.5rem; padding: 0.6rem 1.6rem; font-size: 1rem; cursor: pointer; transition: background 0.2s;">Close</button>
              </div>
            `;
        document.querySelector("#messages-section").appendChild(modal);
      }
      let messagesData = [];
      async function fetchMessages() {
        try {
          const res = await fetch("http://localhost:5000/api/messages");
          if (!res.ok) throw new Error("Failed");
          return await res.json();
        } catch {
          return [];
        }
      }
      async function deleteMessage(id) {
        try {
          const res = await fetch(`http://localhost:5000/api/messages/${id}`, { method: "DELETE" });
          return res.ok;
        } catch {
          return false;
        }
      }
      async function renderMessages() {
        messagesData = await fetchMessages();
        messagesTbody.innerHTML = "";
        messagesData.forEach((msg, idx) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
      <td>${msg.name || msg.from || "-"}</td>
      <td>${msg.email || "-"}</td>
      <td>${msg.subject || "-"}</td>
      <td>${msg.date ? msg.date.split("T")[0] : "-"}</td>
      <td>
        <button class="view-btn" data-idx="${idx}"><i class="fa fa-eye"></i></button>
        <button class="delete-btn" data-idx="${idx}"><i class="fa fa-trash"></i></button>
      </td>
    `;
          messagesTbody.appendChild(tr);
        });
      }
      messagesTbody.addEventListener("click", async function (e) {
        if (e.target.closest(".view-btn")) {
          const idx = e.target.closest(".view-btn").dataset.idx;
          openMessageViewModal(idx);
        } else if (e.target.closest(".delete-btn")) {
          const idx = e.target.closest(".delete-btn").dataset.idx;
          const msg = messagesData[idx];
          if (confirm("Are you sure you want to delete this message?")) {
            if (await deleteMessage(msg._id)) {
              renderMessages();
            } else {
              alert("Failed to delete message.");
            }
          }
        }
      });
      function openMessageViewModal(idx) {
        ensureMessageViewModal();
        messageViewModal = document.getElementById("message-view-modal");
        closeMessageViewModal = document.getElementById("close-message-view-modal");
        messageViewContent = document.getElementById("message-view-content");
        const msg = messagesData[idx];
        messageViewContent.innerHTML = `<strong>From:</strong> ${msg.name || msg.from || "-"}<br><strong>Email:</strong> ${msg.email || "-"}<br><strong>Subject:</strong> ${msg.subject || "-"}<br><strong>Date:</strong> ${msg.date ? msg.date.split("T")[0] : "-"}<br><strong>Message:</strong> ${msg.message || msg.content || "-"}`;
        messageViewModal.style.display = "block";
      }
      // --- Dashboard Stats: Fetch Counts from Backend ---
      async function fetchCount(url) {
        try {
          const res = await fetch(url);
          if (!res.ok) throw new Error("Failed");
          const data = await res.json();
          return Array.isArray(data) ? data.length : data.count || 0;
        } catch {
          return 0;
        }
      }
      async function fetchPatientCount() {
        try {
          const res = await fetch("http://localhost:5000/api/users");
          if (!res.ok) throw new Error("Failed");
          const data = await res.json();
          return Array.isArray(data) ? data.length : data.count || 0;
        } catch {
          return 0;
        }
      }
      async function updateDashboardStats() {
        const [doctorCount, patientCount, appointmentCount] = await Promise.all([
          fetchCount("http://localhost:5000/api/doctors"),
          fetchPatientCount(),
          fetchCount("http://localhost:5000/api/appointments"),
        ]);
        document.querySelectorAll(".stat-label").forEach((el) => {
          if (el.textContent.includes("Doctor"))
            el.nextElementSibling.textContent = doctorCount;
          if (el.textContent.includes("Patient"))
            el.nextElementSibling.textContent = patientCount;
          if (el.textContent.includes("Appointment"))
            el.nextElementSibling.textContent = appointmentCount;
        });
      }
      updateDashboardStats();

      async function fetchDoctors() {
        try {
          const res = await fetch("http://localhost:5000/api/doctors");
          if (!res.ok) throw new Error("Failed");
          return await res.json();
        } catch {
          return [];
        }
      }
      // --- Fix close for message view modal ---
      async function fetchRecentAppointments() {
        try {
          const res = await fetch("http://localhost:5000/api/appointments/recent");
          if (!res.ok) throw new Error("Failed");
          return await res.json();
        } catch {
          return [];
        }
      }
      async function renderRecentAppointments() {
        const recentTbody = document.getElementById("recent-appointments-tbody");
        const apps = await fetchRecentAppointments();
        recentTbody.innerHTML = "";
        apps.forEach((app) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
      <td>${app.patientName || app.patient}</td>
      <td>${app.doctorName || app.doctor}</td>
      <td>${app.date} ${app.time ? app.time : ""}</td>
      <td>${app.status || "Pending"}</td>
    `;
          recentTbody.appendChild(tr);
        });
      }
      // --- Fetch and Render Recent Messages for Dashboard ---
      async function fetchRecentMessages() {
        try {
          const res = await fetch("http://localhost:5000/api/messages/recent");
          if (!res.ok) throw new Error("Failed");
          return await res.json();
        } catch {
          return [];
        }
      }
      async function renderRecentMessages() {
        const recentTbody = document.getElementById("recent-messages-tbody");
        const msgs = await fetchRecentMessages();
        recentTbody.innerHTML = "";
        msgs.forEach((msg) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
      <td>${msg.name || msg.from || "-"}</td>
      <td>${msg.email || "-"}</td>
      <td>${msg.subject || "-"}</td>
      <td>${msg.date ? msg.date.split("T")[0] : "-"}</td>
    `;
          recentTbody.appendChild(tr);
        });
      }
      // Call these on dashboard load
      renderRecentAppointments();
      renderRecentMessages();
    </script>
  </body>
</html>